# bestPixer2UE

## 项目改造说明文档：PeerStreamEnterprise增强版

### 1. 项目概述

本改造项目旨在增强现有开源服务PeerStreamEnterprise的功能性、用户体验和稳定性。PeerStreamEnterprise是一个基于WebRTC的推流服务，结合Unreal Engine (UE) 实现内容推流。当前版本存在一些操作不便和稳定性问题，本次改造将重点解决这些问题，并引入多端口支持和完善的日志系统。

**原始项目地址：** `https://github.com/inveta/PeerStreamEnterprise`

### 2. 当前存在的问题

*   **后台进程残留：** 手动关闭服务后，Unreal Engine (UE) 相关的后台进程可能未被正确终止，导致资源占用和潜在冲突。
*   **配置复杂性：** 服务启动和配置缺乏用户友好的界面，地址输入等操作较为繁琐，不便于非技术用户使用。
*   **部署不便：** 缺乏一个“开箱即用”的打包方式，需要手动配置和启动，不符合快捷部署的需求。
*   **端口冲突/混淆：** WebRTC信令与UE接口（WebSocket）之间可能存在通信混淆或资源争用，因为它们可能没有明确的绑定或隔离。
*   **缺乏错误追溯：** 缺少统一、详细的日志记录，导致服务核心、推流和UE运行时的错误难以追踪和诊断。

### 3. 改造目标与增强功能

本项目将围绕以下核心目标进行改造：

#### 3.1 增强服务关闭机制

*   **目标：** 确保服务手动关闭时，所有关联的UE后台进程能被正确、彻底地终止。
*   **实现方案：**
    *   识别并管理由服务启动的UE进程。
    *   在服务关闭事件（如程序窗口关闭、退出按钮点击）发生时，发送信号或调用系统API优雅地终止这些UE进程。
    *   增加强制终止机制作为备用，以应对UE进程无响应的情况。

#### 3.2 引入快捷设置UI

*   **目标：** 提供一个直观、易用的图形用户界面（GUI），用于服务的快速配置。
*   **实现方案：**
    *   开发一个独立的或内嵌的桌面UI，允许用户设置关键参数。
    *   UI界面至少应包含：
        *   启动/停止服务按钮。
        *   UE程序包路径选择器（文件浏览器）。
        *   WebRTC和WebSocket监听端口设置。
        *   其他必要的服务参数配置。
    *   UI应支持配置的保存和加载，以便下次启动时自动应用。
    *   **推荐技术栈：** 可考虑使用Electron (Web技术)、Qt (C++) 或 WinForms/WPF (.NET) 来构建这个UI，具体取决于当前项目的主语言和团队熟悉度。

#### 3.3 实现打包EXE，开箱即用

*   **目标：** 将服务及其依赖打包成一个独立的Windows可执行文件（EXE），实现“开箱即用”的部署体验。
*   **实现方案：**
    *   调研并选择合适的打包工具（例如：NSIS, Inno Setup, 或如果使用Electron则自带打包能力）。
    *   打包应包含主服务程序、UI程序、必要的运行时库和默认配置文件。
    *   确保打包后的EXE能够独立运行，无需复杂的安装步骤。

#### 3.4 优化地址输入与程序包位置指定

*   **目标：** 简化UE程序包的指定方式，避免手动输入复杂路径，提升用户体验。
*   **实现方案：**
    *   在快捷设置UI中提供一个“浏览”按钮，允许用户通过文件选择器（File Picker）直接定位和选择UE程序（`.exe`）。
    *   将选定的路径保存到配置文件中，以便服务启动时自动加载。

#### 3.5 多端口指令接收与隔离

*   **目标：** 实现服务监听多个端口，不同端口用于接收不同类型的指令，并确保它们之间互不影响。
*   **实现方案：**
    *   **分离协议栈：** 明确区分WebRTC信令（通常是WebSocket或HTTP）和UE控制指令（例如独立的WebSocket连接）。
    *   **配置多个监听器：** 允许服务同时启动多个服务器实例，每个实例绑定到不同的端口和处理逻辑。
        *   例如：`Port A` 专门用于WebRTC信令服务器。
        *   例如：`Port B` 专门用于与UE进行WebSocket通信（如果UE需要单独的WebSocket控制接口）。
    *   **数据隔离：** 确保从一个端口接收到的指令不会错误地路由或影响另一个端口的逻辑处理。维护清晰的内部消息队列或事件处理机制来隔离不同来源的指令。

#### 3.6 完善日志收集与错误报告

*   **目标：** 建立一个全面的日志系统，记录服务运行状态、推流错误和UE运行时错误，并支持日志包的收集。
*   **实现方案：**
    *   **日志级别：** 实现不同级别的日志（如DEBUG, INFO, WARN, ERROR, FATAL）。
    *   **日志模块：** 引入一个成熟的日志库（如Log4net, Serilog等，取决于项目语言）。
    *   **日志输出：** 支持将日志输出到：
        *   控制台（用于调试）。
        *   文件（按日期或大小轮转，方便长期保留）。
        *   UI界面（实时显示关键信息，可选）。
    *   **错误捕获：**
        *   **服务核心错误：** 捕获并记录服务自身的异常和错误。
        *   **推流错误：** 捕获WebRTC相关的错误（如ICE连接失败、SDP解析错误、媒体传输错误等）。
        *   **UE错误：** 监听或捕获UE输出的日志/错误信息（例如通过UE的日志文件、UE输出流重定向或UE提供的API）。
    *   **日志包收集：** 提供一个功能，可以将指定时间范围内的所有相关日志文件打包成一个压缩文件，方便用户提交错误报告。

### 4. 技术栈与开发环境

*   **语言：** 基于PeerStreamEnterprise项目现有的语言（如C++ 或 C#）。UI部分可选择合适的技术栈。
*   **开发环境：** Visual Studio Code (VS Code)
*   **AI辅助：** 充分利用VS Code中的AI插件（如GitHub Copilot, Codeium等）进行代码生成、重构建议、Bug排查等。此文档旨在为AI提供清晰的需求上下文。

### 5. AI辅助开发指引

在VS Code中，当AI辅助时，请参考以下要点：

1.  **理解现有代码结构：** 首先，AI应协助分析PeerStreamEnterprise项目的现有代码库，理解其核心模块、通信机制（WebRTC部分）和与UE的交互方式。
2.  **模块化开发：** 建议将新功能模块化，例如独立的UI模块、进程管理模块、日志模块、多端口监听模块等，以降低耦合度。
3.  **逐步实现：** 建议按照改造目标清单的顺序或并行但独立的方式进行开发和测试。
4.  **测试驱动开发（TDD）：** 鼓励AI协助编写单元测试和集成测试，确保每个新功能和修复都能正常工作。
5.  **代码质量：** 关注代码的可读性、可维护性和性能。AI应协助进行代码审查和优化。
6.  **错误处理与鲁棒性：** 特别关注异常处理机制，确保服务在遇到错误时能够优雅降级或提供清晰的错误信息。


